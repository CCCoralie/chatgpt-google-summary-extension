"use strict";(()=>{var St=Object.create;var Ee=Object.defineProperty;var kt=Object.getOwnPropertyDescriptor;var Et=Object.getOwnPropertyNames;var Ct=Object.getPrototypeOf,jt=Object.prototype.hasOwnProperty;var H=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var It=(e,t,r,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of Et(t))!jt.call(e,a)&&a!==r&&Ee(e,a,{get:()=>t[a],enumerable:!(o=kt(t,a))||o.enumerable});return e};var q=(e,t,r)=>(r=e!=null?St(Ct(e)):{},It(t||!e||!e.__esModule?Ee(r,"default",{value:e,enumerable:!0}):r,e));var K=H((ge,Ce)=>{(function(e,t){if(typeof define=="function"&&define.amd)define("webextension-polyfill",["module"],t);else if(typeof ge<"u")t(Ce);else{var r={exports:{}};t(r),e.browser=r.exports}})(typeof globalThis<"u"?globalThis:typeof self<"u"?self:ge,function(e){"use strict";if(!globalThis.chrome?.runtime?.id)throw new Error("This script should only be loaded in a browser extension.");if(typeof globalThis.browser>"u"||Object.getPrototypeOf(globalThis.browser)!==Object.prototype){let t="The message port closed before a response was received.",r=o=>{let a={alarms:{clear:{minArgs:0,maxArgs:1},clearAll:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getAll:{minArgs:0,maxArgs:0}},bookmarks:{create:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},getChildren:{minArgs:1,maxArgs:1},getRecent:{minArgs:1,maxArgs:1},getSubTree:{minArgs:1,maxArgs:1},getTree:{minArgs:0,maxArgs:0},move:{minArgs:2,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeTree:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}},browserAction:{disable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},enable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},getBadgeBackgroundColor:{minArgs:1,maxArgs:1},getBadgeText:{minArgs:1,maxArgs:1},getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},openPopup:{minArgs:0,maxArgs:0},setBadgeBackgroundColor:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setBadgeText:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},browsingData:{remove:{minArgs:2,maxArgs:2},removeCache:{minArgs:1,maxArgs:1},removeCookies:{minArgs:1,maxArgs:1},removeDownloads:{minArgs:1,maxArgs:1},removeFormData:{minArgs:1,maxArgs:1},removeHistory:{minArgs:1,maxArgs:1},removeLocalStorage:{minArgs:1,maxArgs:1},removePasswords:{minArgs:1,maxArgs:1},removePluginData:{minArgs:1,maxArgs:1},settings:{minArgs:0,maxArgs:0}},commands:{getAll:{minArgs:0,maxArgs:0}},contextMenus:{remove:{minArgs:1,maxArgs:1},removeAll:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},cookies:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:1,maxArgs:1},getAllCookieStores:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},devtools:{inspectedWindow:{eval:{minArgs:1,maxArgs:2,singleCallbackArg:!1}},panels:{create:{minArgs:3,maxArgs:3,singleCallbackArg:!0},elements:{createSidebarPane:{minArgs:1,maxArgs:1}}}},downloads:{cancel:{minArgs:1,maxArgs:1},download:{minArgs:1,maxArgs:1},erase:{minArgs:1,maxArgs:1},getFileIcon:{minArgs:1,maxArgs:2},open:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},pause:{minArgs:1,maxArgs:1},removeFile:{minArgs:1,maxArgs:1},resume:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},extension:{isAllowedFileSchemeAccess:{minArgs:0,maxArgs:0},isAllowedIncognitoAccess:{minArgs:0,maxArgs:0}},history:{addUrl:{minArgs:1,maxArgs:1},deleteAll:{minArgs:0,maxArgs:0},deleteRange:{minArgs:1,maxArgs:1},deleteUrl:{minArgs:1,maxArgs:1},getVisits:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1}},i18n:{detectLanguage:{minArgs:1,maxArgs:1},getAcceptLanguages:{minArgs:0,maxArgs:0}},identity:{launchWebAuthFlow:{minArgs:1,maxArgs:1}},idle:{queryState:{minArgs:1,maxArgs:1}},management:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},getSelf:{minArgs:0,maxArgs:0},setEnabled:{minArgs:2,maxArgs:2},uninstallSelf:{minArgs:0,maxArgs:1}},notifications:{clear:{minArgs:1,maxArgs:1},create:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:0},getPermissionLevel:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},pageAction:{getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},hide:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},permissions:{contains:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},request:{minArgs:1,maxArgs:1}},runtime:{getBackgroundPage:{minArgs:0,maxArgs:0},getPlatformInfo:{minArgs:0,maxArgs:0},openOptionsPage:{minArgs:0,maxArgs:0},requestUpdateCheck:{minArgs:0,maxArgs:0},sendMessage:{minArgs:1,maxArgs:3},sendNativeMessage:{minArgs:2,maxArgs:2},setUninstallURL:{minArgs:1,maxArgs:1}},sessions:{getDevices:{minArgs:0,maxArgs:1},getRecentlyClosed:{minArgs:0,maxArgs:1},restore:{minArgs:0,maxArgs:1}},storage:{local:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},managed:{get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1}},sync:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}}},tabs:{captureVisibleTab:{minArgs:0,maxArgs:2},create:{minArgs:1,maxArgs:1},detectLanguage:{minArgs:0,maxArgs:1},discard:{minArgs:0,maxArgs:1},duplicate:{minArgs:1,maxArgs:1},executeScript:{minArgs:1,maxArgs:2},get:{minArgs:1,maxArgs:1},getCurrent:{minArgs:0,maxArgs:0},getZoom:{minArgs:0,maxArgs:1},getZoomSettings:{minArgs:0,maxArgs:1},goBack:{minArgs:0,maxArgs:1},goForward:{minArgs:0,maxArgs:1},highlight:{minArgs:1,maxArgs:1},insertCSS:{minArgs:1,maxArgs:2},move:{minArgs:2,maxArgs:2},query:{minArgs:1,maxArgs:1},reload:{minArgs:0,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeCSS:{minArgs:1,maxArgs:2},sendMessage:{minArgs:2,maxArgs:3},setZoom:{minArgs:1,maxArgs:2},setZoomSettings:{minArgs:1,maxArgs:2},update:{minArgs:1,maxArgs:2}},topSites:{get:{minArgs:0,maxArgs:0}},webNavigation:{getAllFrames:{minArgs:1,maxArgs:1},getFrame:{minArgs:1,maxArgs:1}},webRequest:{handlerBehaviorChanged:{minArgs:0,maxArgs:0}},windows:{create:{minArgs:0,maxArgs:1},get:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:1},getCurrent:{minArgs:0,maxArgs:1},getLastFocused:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}}};if(Object.keys(a).length===0)throw new Error("api-metadata.json has not been included in browser-polyfill");class l extends WeakMap{constructor(n,m=void 0){super(m),this.createItem=n}get(n){return this.has(n)||this.set(n,this.createItem(n)),super.get(n)}}let i=s=>s&&typeof s=="object"&&typeof s.then=="function",g=(s,n)=>(...m)=>{o.runtime.lastError?s.reject(new Error(o.runtime.lastError.message)):n.singleCallbackArg||m.length<=1&&n.singleCallbackArg!==!1?s.resolve(m[0]):s.resolve(m)},x=s=>s==1?"argument":"arguments",h=(s,n)=>function(u,...b){if(b.length<n.minArgs)throw new Error(`Expected at least ${n.minArgs} ${x(n.minArgs)} for ${s}(), got ${b.length}`);if(b.length>n.maxArgs)throw new Error(`Expected at most ${n.maxArgs} ${x(n.maxArgs)} for ${s}(), got ${b.length}`);return new Promise((k,C)=>{if(n.fallbackToNoCallback)try{u[s](...b,g({resolve:k,reject:C},n))}catch{u[s](...b),n.fallbackToNoCallback=!1,n.noCallback=!0,k()}else n.noCallback?(u[s](...b),k()):u[s](...b,g({resolve:k,reject:C},n))})},v=(s,n,m)=>new Proxy(n,{apply(u,b,k){return m.call(b,s,...k)}}),P=Function.call.bind(Object.prototype.hasOwnProperty),A=(s,n={},m={})=>{let u=Object.create(null),b={has(C,f){return f in s||f in u},get(C,f,j){if(f in u)return u[f];if(!(f in s))return;let y=s[f];if(typeof y=="function")if(typeof n[f]=="function")y=v(s,s[f],n[f]);else if(P(m,f)){let L=h(f,m[f]);y=v(s,s[f],L)}else y=y.bind(s);else if(typeof y=="object"&&y!==null&&(P(n,f)||P(m,f)))y=A(y,n[f],m[f]);else if(P(m,"*"))y=A(y,n[f],m["*"]);else return Object.defineProperty(u,f,{configurable:!0,enumerable:!0,get(){return s[f]},set(L){s[f]=L}}),y;return u[f]=y,y},set(C,f,j,y){return f in u?u[f]=j:s[f]=j,!0},defineProperty(C,f,j){return Reflect.defineProperty(u,f,j)},deleteProperty(C,f){return Reflect.deleteProperty(u,f)}},k=Object.create(s);return new Proxy(k,b)},d=s=>({addListener(n,m,...u){n.addListener(s.get(m),...u)},hasListener(n,m){return n.hasListener(s.get(m))},removeListener(n,m){n.removeListener(s.get(m))}}),O=new l(s=>typeof s!="function"?s:function(m){let u=A(m,{},{getContent:{minArgs:0,maxArgs:0}});s(u)}),E=new l(s=>typeof s!="function"?s:function(m,u,b){let k=!1,C,f=new Promise($=>{C=function(R){k=!0,$(R)}}),j;try{j=s(m,u,C)}catch($){j=Promise.reject($)}let y=j!==!0&&i(j);if(j!==!0&&!y&&!k)return!1;let L=$=>{$.then(R=>{b(R)},R=>{let ce;R&&(R instanceof Error||typeof R.message=="string")?ce=R.message:ce="An unexpected error occurred",b({__mozWebExtensionPolyfillReject__:!0,message:ce})}).catch(R=>{})};return L(y?j:f),!0}),I=({reject:s,resolve:n},m)=>{o.runtime.lastError?o.runtime.lastError.message===t?n():s(new Error(o.runtime.lastError.message)):m&&m.__mozWebExtensionPolyfillReject__?s(new Error(m.message)):n(m)},S=(s,n,m,...u)=>{if(u.length<n.minArgs)throw new Error(`Expected at least ${n.minArgs} ${x(n.minArgs)} for ${s}(), got ${u.length}`);if(u.length>n.maxArgs)throw new Error(`Expected at most ${n.maxArgs} ${x(n.maxArgs)} for ${s}(), got ${u.length}`);return new Promise((b,k)=>{let C=I.bind(null,{resolve:b,reject:k});u.push(C),m.sendMessage(...u)})},M={devtools:{network:{onRequestFinished:d(O)}},runtime:{onMessage:d(E),onMessageExternal:d(E),sendMessage:S.bind(null,"sendMessage",{minArgs:1,maxArgs:3})},tabs:{sendMessage:S.bind(null,"sendMessage",{minArgs:2,maxArgs:3})}},W={clear:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}};return a.privacy={network:{"*":W},services:{"*":W},websites:{"*":W}},A(o,M,a)};e.exports=r(chrome)}else e.exports=globalThis.browser})});var lt=H((Es,mt)=>{"use strict";mt.exports=()=>{let e={};return e.promise=new Promise((t,r)=>{e.resolve=t,e.reject=r}),e}});var ut=H((Cs,dt)=>{"use strict";var Po=lt();function So(e,t="maxAge"){let r,o,a,l=async()=>{if(r!==void 0)return;let x=async h=>{a=Po();let v=h[1][t]-Date.now();if(v<=0){e.delete(h[0]),a.resolve();return}return r=h[0],o=setTimeout(()=>{e.delete(h[0]),a&&a.resolve()},v),typeof o.unref=="function"&&o.unref(),a.promise};try{for(let h of e)await x(h)}catch{}r=void 0},i=()=>{r=void 0,o!==void 0&&(clearTimeout(o),o=void 0),a!==void 0&&(a.reject(void 0),a=void 0)},g=e.set.bind(e);return e.set=(x,h)=>{e.has(x)&&e.delete(x);let v=g(x,h);return r&&r===x&&i(),l(),v},l(),e}dt.exports=So});var ct=H((js,pt)=>{"use strict";var ko=ut(),be=class{constructor(t,r){if(this.maxAge=t,this[Symbol.toStringTag]="Map",this.data=new Map,ko(this.data),r)for(let[o,a]of r)this.set(o,a)}get size(){return this.data.size}clear(){this.data.clear()}delete(t){return this.data.delete(t)}has(t){return this.data.has(t)}get(t){let r=this.data.get(t);if(r)return r.data}set(t,r){return this.data.set(t,{maxAge:Date.now()+this.maxAge,data:r}),this}values(){return this.createIterator(t=>t[1].data)}keys(){return this.data.keys()}entries(){return this.createIterator(t=>[t[0],t[1].data])}forEach(t,r){for(let[o,a]of this.entries())t.apply(r,[a,o,this])}[Symbol.iterator](){return this.entries()}*createIterator(t){for(let r of this.data.entries())yield t(r)}};pt.exports=be});var c=q(K());var Mt=typeof global=="object"&&global&&global.Object===Object&&global,J=Mt;var Ot=typeof self=="object"&&self&&self.Object===Object&&self,Nt=J||Ot||Function("return this")(),w=Nt;var Rt=w.Symbol,D=Rt;var je=Object.prototype,_t=je.hasOwnProperty,Bt=je.toString,z=D?D.toStringTag:void 0;function Ut(e){var t=_t.call(e,z),r=e[z];try{e[z]=void 0;var o=!0}catch{}var a=Bt.call(e);return o&&(t?e[z]=r:delete e[z]),a}var Ie=Ut;var Gt=Object.prototype,Lt=Gt.toString;function Dt(e){return Lt.call(e)}var Me=Dt;var Ft="[object Null]",Wt="[object Undefined]",Oe=D?D.toStringTag:void 0;function $t(e){return e==null?e===void 0?Wt:Ft:Oe&&Oe in Object(e)?Ie(e):Me(e)}var _=$t;function qt(e){return e!=null&&typeof e=="object"}var F=qt;var Kt=Array.isArray,Ne=Kt;function zt(e){var t=typeof e;return e!=null&&(t=="object"||t=="function")}var Z=zt;var Vt="[object AsyncFunction]",Ht="[object Function]",Jt="[object GeneratorFunction]",Zt="[object Proxy]";function Yt(e){if(!Z(e))return!1;var t=_(e);return t==Ht||t==Jt||t==Vt||t==Zt}var Y=Yt;var Xt=w["__core-js_shared__"],X=Xt;var Re=function(){var e=/[^.]+$/.exec(X&&X.keys&&X.keys.IE_PROTO||"");return e?"Symbol(src)_1."+e:""}();function Qt(e){return!!Re&&Re in e}var _e=Qt;var er=Function.prototype,tr=er.toString;function rr(e){if(e!=null){try{return tr.call(e)}catch{}try{return e+""}catch{}}return""}var B=rr;var or=/[\\^$.*+?()[\]{}|]/g,ar=/^\[object .+?Constructor\]$/,sr=Function.prototype,nr=Object.prototype,ir=sr.toString,fr=nr.hasOwnProperty,mr=RegExp("^"+ir.call(fr).replace(or,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function lr(e){if(!Z(e)||_e(e))return!1;var t=Y(e)?mr:ar;return t.test(B(e))}var Be=lr;function dr(e,t){return e?.[t]}var Ue=dr;function ur(e,t){var r=Ue(e,t);return Be(r)?r:void 0}var N=ur;var pr=N(w,"WeakMap"),Q=pr;var cr=9007199254740991;function gr(e){return typeof e=="number"&&e>-1&&e%1==0&&e<=cr}var ee=gr;function xr(e){return e!=null&&ee(e.length)&&!Y(e)}var Ge=xr;var Ar=Object.prototype;function hr(e){var t=e&&e.constructor,r=typeof t=="function"&&t.prototype||Ar;return e===r}var te=hr;var yr="[object Arguments]";function br(e){return F(e)&&_(e)==yr}var xe=br;var Le=Object.prototype,Tr=Le.hasOwnProperty,wr=Le.propertyIsEnumerable,vr=xe(function(){return arguments}())?xe:function(e){return F(e)&&Tr.call(e,"callee")&&!wr.call(e,"callee")},De=vr;function Pr(){return!1}var Fe=Pr;var qe=typeof exports=="object"&&exports&&!exports.nodeType&&exports,We=qe&&typeof module=="object"&&module&&!module.nodeType&&module,Sr=We&&We.exports===qe,$e=Sr?w.Buffer:void 0,kr=$e?$e.isBuffer:void 0,Er=kr||Fe,Ke=Er;var Cr="[object Arguments]",jr="[object Array]",Ir="[object Boolean]",Mr="[object Date]",Or="[object Error]",Nr="[object Function]",Rr="[object Map]",_r="[object Number]",Br="[object Object]",Ur="[object RegExp]",Gr="[object Set]",Lr="[object String]",Dr="[object WeakMap]",Fr="[object ArrayBuffer]",Wr="[object DataView]",$r="[object Float32Array]",qr="[object Float64Array]",Kr="[object Int8Array]",zr="[object Int16Array]",Vr="[object Int32Array]",Hr="[object Uint8Array]",Jr="[object Uint8ClampedArray]",Zr="[object Uint16Array]",Yr="[object Uint32Array]",p={};p[$r]=p[qr]=p[Kr]=p[zr]=p[Vr]=p[Hr]=p[Jr]=p[Zr]=p[Yr]=!0;p[Cr]=p[jr]=p[Fr]=p[Ir]=p[Wr]=p[Mr]=p[Or]=p[Nr]=p[Rr]=p[_r]=p[Br]=p[Ur]=p[Gr]=p[Lr]=p[Dr]=!1;function Xr(e){return F(e)&&ee(e.length)&&!!p[_(e)]}var ze=Xr;function Qr(e){return function(t){return e(t)}}var Ve=Qr;var He=typeof exports=="object"&&exports&&!exports.nodeType&&exports,V=He&&typeof module=="object"&&module&&!module.nodeType&&module,eo=V&&V.exports===He,Ae=eo&&J.process,to=function(){try{var e=V&&V.require&&V.require("util").types;return e||Ae&&Ae.binding&&Ae.binding("util")}catch{}}(),he=to;var Je=he&&he.isTypedArray,ro=Je?Ve(Je):ze,Ze=ro;function oo(e,t){return function(r){return e(t(r))}}var Ye=oo;var ao=Ye(Object.keys,Object),Xe=ao;var so=Object.prototype,no=so.hasOwnProperty;function io(e){if(!te(e))return Xe(e);var t=[];for(var r in Object(e))no.call(e,r)&&r!="constructor"&&t.push(r);return t}var Qe=io;var fo=N(w,"Map"),re=fo;var mo=N(w,"DataView"),oe=mo;var lo=N(w,"Promise"),ae=lo;var uo=N(w,"Set"),se=uo;var et="[object Map]",po="[object Object]",tt="[object Promise]",rt="[object Set]",ot="[object WeakMap]",at="[object DataView]",co=B(oe),go=B(re),xo=B(ae),Ao=B(se),ho=B(Q),G=_;(oe&&G(new oe(new ArrayBuffer(1)))!=at||re&&G(new re)!=et||ae&&G(ae.resolve())!=tt||se&&G(new se)!=rt||Q&&G(new Q)!=ot)&&(G=function(e){var t=_(e),r=t==po?e.constructor:void 0,o=r?B(r):"";if(o)switch(o){case co:return at;case go:return et;case xo:return tt;case Ao:return rt;case ho:return ot}return t});var st=G;var yo="[object Map]",bo="[object Set]",To=Object.prototype,wo=To.hasOwnProperty;function vo(e){if(e==null)return!0;if(Ge(e)&&(Ne(e)||typeof e=="string"||typeof e.splice=="function"||Ke(e)||Ze(e)||De(e)))return!e.length;var t=st(e);if(t==yo||t==bo)return!e.size;if(te(e))return!Qe(e).length;for(var r in e)if(wo.call(e,r))return!1;return!0}var ye=vo;var ne=q(K());var U="https://chat.openai.com";async function ie(){let{provider:e="chatgpt"}=await ne.default.storage.local.get("provider"),t="provider:gpt3",r=await ne.default.storage.local.get(t),o=await ne.default.storage.local.get("chatModel");return{provider:e,configs:{["gpt3"]:r[t]},chatModel:o.chatModel}}var nt="gpt-3.5-turbo",it="api.openai.com",ft="text-davinci-002-render-sha";var yt=q(ct());var fe,Eo=new Uint8Array(16);function Te(){if(!fe&&(fe=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!fe))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return fe(Eo)}var T=[];for(let e=0;e<256;++e)T.push((e+256).toString(16).slice(1));function gt(e,t=0){return(T[e[t+0]]+T[e[t+1]]+T[e[t+2]]+T[e[t+3]]+"-"+T[e[t+4]]+T[e[t+5]]+"-"+T[e[t+6]]+T[e[t+7]]+"-"+T[e[t+8]]+T[e[t+9]]+"-"+T[e[t+10]]+T[e[t+11]]+T[e[t+12]]+T[e[t+13]]+T[e[t+14]]+T[e[t+15]]).toLowerCase()}var Co=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),we={randomUUID:Co};function jo(e,t,r){if(we.randomUUID&&!t&&!e)return we.randomUUID();e=e||{};let o=e.random||(e.rng||Te)();if(o[6]=o[6]&15|64,o[8]=o[8]&63|128,t){r=r||0;for(let a=0;a<16;++a)t[r+a]=o[a];return t}return gt(o)}var me=jo;function xt(e){let t,r,o,a,l,i,g;return x(),{feed:h,reset:x};function x(){t=!0,r="",o=0,a=-1,l=void 0,i=void 0,g=""}function h(P){r=r?r+P:P,t&&Io(r)&&(r=r.slice(At.length)),t=!1;let A=r.length,d=0,O=!1;for(;d<A;){O&&(r[d]===`
`&&++d,O=!1);let E=-1,I=a,S;for(let M=o;E<0&&M<A;++M)S=r[M],S===":"&&I<0?I=M-d:S==="\r"?(O=!0,E=M-d):S===`
`&&(E=M-d);if(E<0){o=A-d,a=I;break}else o=0,a=-1;v(r,d,I,E),d+=E+1}d===A?r="":d>0&&(r=r.slice(d))}function v(P,A,d,O){if(O===0){g.length>0&&(e({type:"event",id:l,event:i||void 0,data:g.slice(0,-1)}),g="",l=void 0),i=void 0;return}let E=d<0,I=P.slice(A,A+(E?O:d)),S=0;E?S=O:P[A+d+1]===" "?S=d+2:S=d+1;let M=A+S,W=O-S,s=P.slice(M,M+W).toString();if(I==="data")g+=s?"".concat(s,`
`):`
`;else if(I==="event")i=s;else if(I==="id"&&!s.includes("\0"))l=s;else if(I==="retry"){let n=parseInt(s,10);Number.isNaN(n)||e({type:"reconnect-interval",value:n})}}}var At=[239,187,191];function Io(e){return At.every((t,r)=>e.charCodeAt(r)===t)}async function*ht(e){let t=e.getReader();try{for(;;){let{done:r,value:o}=await t.read();if(r)return;yield o}}finally{t.releaseLock()}}async function le(e,t){let{onMessage:r,...o}=t,a=await fetch(e,o);if(!a.ok){let i=await a.json().catch(()=>({}));throw new Error(ye(i)?`${a.status} ${a.statusText}`:JSON.stringify(i))}let l=xt(i=>{i.type==="event"&&r(i.data)});for await(let i of ht(a.body)){let g=new TextDecoder().decode(i);l.feed(g)}}var bt=q(K());async function Se(e,t,r,o){return fetch(`${U}/backend-api${r}`,{method:t,headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:o===void 0?void 0:JSON.stringify(o)})}async function Tt(e,t){await Se(e,"POST","/conversation/message_feedback",t)}async function Mo(e,t,r){await Se(e,"PATCH",`/conversation/${t}`,r)}var ve="accessToken",Pe=new yt.default(10*1e3);async function ue(){if(Pe.get(ve))return Pe.get(ve);let e=await fetch(`${U}/api/auth/session`);if(e.status===403)throw new Error("CLOUDFLARE");let t=await e.json().catch(()=>({}));if(!t.accessToken)throw new Error("UNAUTHORIZED");return Pe.set(ve,t.accessToken),t.accessToken}var de=class{constructor(t){this.token=t;this.token=t}async fetchModels(){return(await Se(this.token,"GET","/models").then(r=>r.json())).models}async getModelName(){var t,r;try{let o=(r=(t=await bt.default.storage.local.get("chatModel"))==null?void 0:t.chatModel)!=null?r:"GPT-3.5 Turbo",a=await this.fetchModels();if(o==="auto"){let l=a.find(i=>i.slug==="gpt-4");return(l==null?void 0:l.slug)||a[0].slug}return a[0].slug}catch(o){return ft}}async generateAnswer(t){let r,o=()=>{r&&Mo(this.token,r,{is_visible:!1})},a=await this.getModelName();return await le(`${U}/backend-api/conversation`,{method:"POST",signal:t.signal,headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.token}`},body:JSON.stringify({action:"next",messages:[{id:me(),role:"user",content:{content_type:"text",parts:[t.prompt]}}],model:a,parent_message_id:me()}),onMessage(l){var x,h,v;if(l==="[DONE]"){t.onEvent({type:"done"}),o();return}let i;try{i=JSON.parse(l)}catch(P){return}let g=(v=(h=(x=i.message)==null?void 0:x.content)==null?void 0:h.parts)==null?void 0:v[0];g&&(r=i.conversation_id,t.onEvent({type:"answer",data:{text:g,messageId:i.message.id,conversationId:i.conversation_id}}))}}),{cleanup:o}}};var pe=class{constructor(t,r){this.token=t;this.model=r;this.token=t,this.model=r}buildPrompt(t){return this.model.startsWith("text-chat-davinci")?`Respond conversationally.<|im_end|>

User: ${t}<|im_sep|>
ChatGPT:`:t}buildMessages(t){return[{role:"user",content:t}]}async generateAnswer(t){var x,h,v;let[r]=await Promise.all([ie()]),o=(h=(x=r.configs["gpt3"])==null?void 0:x.model)!=null?h:nt,a=((v=r.configs["gpt3"])==null?void 0:v.apiHost)||it,l="",i={model:this.model,stream:!0,max_tokens:800};o==="text-davinci-003"?(l=`https://${a}/v1/completions`,i={...i,prompt:this.buildPrompt(t.prompt)}):(l=`https://${a}/v1/chat/completions`,i={...i,messages:this.buildMessages(t.prompt)});let g="";return await le(l,{method:"POST",signal:t.signal,headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.token}`},body:JSON.stringify(i),onMessage(P){if(P==="[DONE]"){t.onEvent({type:"done"});return}let A;try{A=JSON.parse(P);let d=o==="text-davinci-003"?A.choices[0].text:A.choices[0].delta.content;if(d===void 0||d==="<|im_end|>"||d==="<|im_sep|>")return;g+=d,t.onEvent({type:"answer",data:{text:g,messageId:A.id,conversationId:A.id}})}catch(d){return}}}),{}}};var ke=q(K());var tn=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),wt=navigator.userAgent.indexOf("Firefox")!=-1,rn=/iPad|iPhone|iPod/.test(navigator.userAgent);function vt(e){let{id:t,url:r}=e;r.includes(`${U}/chat`)?ke.default.tabs.sendMessage(t,{type:"CHATGPT_TAB_CURRENT",data:{isLogin:!0}}).catch(()=>{}):ke.default.tabs.sendMessage(t,{type:"CHATGPT_TAB_CURRENT",data:{isLogin:!1}}).catch(()=>{})}async function No(e,t){let r=await ie(),o;if(r.provider==="chatgpt"){let i=await ue();o=new de(i)}else if(r.provider==="gpt3"){let{apiKey:i,model:g}=r.configs["gpt3"];o=new pe(i,g)}else throw new Error(`Unknown provider ${r.provider}`);let a=new AbortController;e.onDisconnect.addListener(()=>{a.abort(),l==null||l()});let{cleanup:l}=await o.generateAnswer({prompt:t,signal:a.signal,onEvent(i){if(i.type==="done"){e.postMessage({event:"DONE"});return}e.postMessage(i.data)}})}async function Ro(e){c.default.tabs.query({currentWindow:!0,active:!0}).then(o=>{let a=o[0];a.id&&c.default.storage.local.set({glarityTabId:a.id})});let t=await c.default.storage.local.get("pinnedTabId"),r;if(t.pinnedTabId)try{r=await c.default.tabs.get(t.pinnedTabId),c.default.tabs.update(r.id,{active:!0,pinned:!0})}catch(o){}return r||(r=await c.default.tabs.create({url:e,pinned:!0,active:!0})),c.default.storage.local.set({pinnedTabId:r.id}),{pinnedTabId:r.id}}c.default.runtime.onConnect.addListener(async e=>{e.onMessage.addListener(async t=>{try{await No(e,t.question)}catch(r){e.postMessage({error:r.message})}})});c.default.runtime.onMessage.addListener(async e=>{if(e.type==="FEEDBACK"){let t=await ue();await Tt(t,e.data)}else if(e.type==="OPEN_OPTIONS_PAGE")c.default.runtime.openOptionsPage();else{if(e.type==="GET_ACCESS_TOKEN")return ue();if(e.type==="NEW_TAB")return Ro(e.data.url);if(e.type==="GO_BACK"){let t=await c.default.storage.local.get("glarityTabId");t.glarityTabId?c.default.tabs.update(t.glarityTabId,{active:!0}).catch(()=>{c.default.tabs.create({url:"about:newtab",active:!0})}):c.default.tabs.create({url:"about:newtab",active:!0})}}});c.default.runtime.onInstalled.addListener(async e=>{e.reason==="install"&&c.default.runtime.openOptionsPage()});c.default.tabs.onUpdated.addListener(async(e,t)=>{let r=await c.default.storage.local.get("pinnedTabId");c.default.tabs.get(e).then(o=>{var a;(a=o.url)!=null&&a.includes(U)&&t.status==="complete"&&o.id&&r.pinnedTabId===o.id&&vt(o)})});async function Pt(e){let{id:t}=e;t&&c.default.tabs.sendMessage(t,{type:"OPEN_WEB_SUMMARY",data:{}}).catch(()=>{})}wt?c.default.browserAction.onClicked.addListener(async e=>{await Pt(e)}):c.default.action.onClicked.addListener(async e=>{await Pt(e)});})();
