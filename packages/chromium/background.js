"use strict";(()=>{var Ct=Object.create;var Ee=Object.defineProperty;var Et=Object.getOwnPropertyDescriptor;var It=Object.getOwnPropertyNames;var jt=Object.getPrototypeOf,Mt=Object.prototype.hasOwnProperty;var Y=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var Ot=(e,t,r,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of It(t))!Mt.call(e,a)&&a!==r&&Ee(e,a,{get:()=>t[a],enumerable:!(o=Et(t,a))||o.enumerable});return e};var K=(e,t,r)=>(r=e!=null?Ct(jt(e)):{},Ot(t||!e||!e.__esModule?Ee(r,"default",{value:e,enumerable:!0}):r,e));var V=Y((Ae,Ie)=>{(function(e,t){if(typeof define=="function"&&define.amd)define("webextension-polyfill",["module"],t);else if(typeof Ae<"u")t(Ie);else{var r={exports:{}};t(r),e.browser=r.exports}})(typeof globalThis<"u"?globalThis:typeof self<"u"?self:Ae,function(e){"use strict";if(!globalThis.chrome?.runtime?.id)throw new Error("This script should only be loaded in a browser extension.");if(typeof globalThis.browser>"u"||Object.getPrototypeOf(globalThis.browser)!==Object.prototype){let t="The message port closed before a response was received.",r=o=>{let a={alarms:{clear:{minArgs:0,maxArgs:1},clearAll:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getAll:{minArgs:0,maxArgs:0}},bookmarks:{create:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},getChildren:{minArgs:1,maxArgs:1},getRecent:{minArgs:1,maxArgs:1},getSubTree:{minArgs:1,maxArgs:1},getTree:{minArgs:0,maxArgs:0},move:{minArgs:2,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeTree:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}},browserAction:{disable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},enable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},getBadgeBackgroundColor:{minArgs:1,maxArgs:1},getBadgeText:{minArgs:1,maxArgs:1},getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},openPopup:{minArgs:0,maxArgs:0},setBadgeBackgroundColor:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setBadgeText:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},browsingData:{remove:{minArgs:2,maxArgs:2},removeCache:{minArgs:1,maxArgs:1},removeCookies:{minArgs:1,maxArgs:1},removeDownloads:{minArgs:1,maxArgs:1},removeFormData:{minArgs:1,maxArgs:1},removeHistory:{minArgs:1,maxArgs:1},removeLocalStorage:{minArgs:1,maxArgs:1},removePasswords:{minArgs:1,maxArgs:1},removePluginData:{minArgs:1,maxArgs:1},settings:{minArgs:0,maxArgs:0}},commands:{getAll:{minArgs:0,maxArgs:0}},contextMenus:{remove:{minArgs:1,maxArgs:1},removeAll:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},cookies:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:1,maxArgs:1},getAllCookieStores:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},devtools:{inspectedWindow:{eval:{minArgs:1,maxArgs:2,singleCallbackArg:!1}},panels:{create:{minArgs:3,maxArgs:3,singleCallbackArg:!0},elements:{createSidebarPane:{minArgs:1,maxArgs:1}}}},downloads:{cancel:{minArgs:1,maxArgs:1},download:{minArgs:1,maxArgs:1},erase:{minArgs:1,maxArgs:1},getFileIcon:{minArgs:1,maxArgs:2},open:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},pause:{minArgs:1,maxArgs:1},removeFile:{minArgs:1,maxArgs:1},resume:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},extension:{isAllowedFileSchemeAccess:{minArgs:0,maxArgs:0},isAllowedIncognitoAccess:{minArgs:0,maxArgs:0}},history:{addUrl:{minArgs:1,maxArgs:1},deleteAll:{minArgs:0,maxArgs:0},deleteRange:{minArgs:1,maxArgs:1},deleteUrl:{minArgs:1,maxArgs:1},getVisits:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1}},i18n:{detectLanguage:{minArgs:1,maxArgs:1},getAcceptLanguages:{minArgs:0,maxArgs:0}},identity:{launchWebAuthFlow:{minArgs:1,maxArgs:1}},idle:{queryState:{minArgs:1,maxArgs:1}},management:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},getSelf:{minArgs:0,maxArgs:0},setEnabled:{minArgs:2,maxArgs:2},uninstallSelf:{minArgs:0,maxArgs:1}},notifications:{clear:{minArgs:1,maxArgs:1},create:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:0},getPermissionLevel:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},pageAction:{getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},hide:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},permissions:{contains:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},request:{minArgs:1,maxArgs:1}},runtime:{getBackgroundPage:{minArgs:0,maxArgs:0},getPlatformInfo:{minArgs:0,maxArgs:0},openOptionsPage:{minArgs:0,maxArgs:0},requestUpdateCheck:{minArgs:0,maxArgs:0},sendMessage:{minArgs:1,maxArgs:3},sendNativeMessage:{minArgs:2,maxArgs:2},setUninstallURL:{minArgs:1,maxArgs:1}},sessions:{getDevices:{minArgs:0,maxArgs:1},getRecentlyClosed:{minArgs:0,maxArgs:1},restore:{minArgs:0,maxArgs:1}},storage:{local:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},managed:{get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1}},sync:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}}},tabs:{captureVisibleTab:{minArgs:0,maxArgs:2},create:{minArgs:1,maxArgs:1},detectLanguage:{minArgs:0,maxArgs:1},discard:{minArgs:0,maxArgs:1},duplicate:{minArgs:1,maxArgs:1},executeScript:{minArgs:1,maxArgs:2},get:{minArgs:1,maxArgs:1},getCurrent:{minArgs:0,maxArgs:0},getZoom:{minArgs:0,maxArgs:1},getZoomSettings:{minArgs:0,maxArgs:1},goBack:{minArgs:0,maxArgs:1},goForward:{minArgs:0,maxArgs:1},highlight:{minArgs:1,maxArgs:1},insertCSS:{minArgs:1,maxArgs:2},move:{minArgs:2,maxArgs:2},query:{minArgs:1,maxArgs:1},reload:{minArgs:0,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeCSS:{minArgs:1,maxArgs:2},sendMessage:{minArgs:2,maxArgs:3},setZoom:{minArgs:1,maxArgs:2},setZoomSettings:{minArgs:1,maxArgs:2},update:{minArgs:1,maxArgs:2}},topSites:{get:{minArgs:0,maxArgs:0}},webNavigation:{getAllFrames:{minArgs:1,maxArgs:1},getFrame:{minArgs:1,maxArgs:1}},webRequest:{handlerBehaviorChanged:{minArgs:0,maxArgs:0}},windows:{create:{minArgs:0,maxArgs:1},get:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:1},getCurrent:{minArgs:0,maxArgs:1},getLastFocused:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}}};if(Object.keys(a).length===0)throw new Error("api-metadata.json has not been included in browser-polyfill");class m extends WeakMap{constructor(n,f=void 0){super(f),this.createItem=n}get(n){return this.has(n)||this.set(n,this.createItem(n)),super.get(n)}}let d=s=>s&&typeof s=="object"&&typeof s.then=="function",y=(s,n)=>(...f)=>{o.runtime.lastError?s.reject(new Error(o.runtime.lastError.message)):n.singleCallbackArg||f.length<=1&&n.singleCallbackArg!==!1?s.resolve(f[0]):s.resolve(f)},c=s=>s==1?"argument":"arguments",A=(s,n)=>function(u,...P){if(P.length<n.minArgs)throw new Error(`Expected at least ${n.minArgs} ${c(n.minArgs)} for ${s}(), got ${P.length}`);if(P.length>n.maxArgs)throw new Error(`Expected at most ${n.maxArgs} ${c(n.maxArgs)} for ${s}(), got ${P.length}`);return new Promise((I,j)=>{if(n.fallbackToNoCallback)try{u[s](...P,y({resolve:I,reject:j},n))}catch{u[s](...P),n.fallbackToNoCallback=!1,n.noCallback=!0,I()}else n.noCallback?(u[s](...P),I()):u[s](...P,y({resolve:I,reject:j},n))})},b=(s,n,f)=>new Proxy(n,{apply(u,P,I){return f.call(P,s,...I)}}),w=Function.call.bind(Object.prototype.hasOwnProperty),x=(s,n={},f={})=>{let u=Object.create(null),P={has(j,i){return i in s||i in u},get(j,i,M){if(i in u)return u[i];if(!(i in s))return;let T=s[i];if(typeof T=="function")if(typeof n[i]=="function")T=b(s,s[i],n[i]);else if(w(f,i)){let L=A(i,f[i]);T=b(s,s[i],L)}else T=T.bind(s);else if(typeof T=="object"&&T!==null&&(w(n,i)||w(f,i)))T=x(T,n[i],f[i]);else if(w(f,"*"))T=x(T,n[i],f["*"]);else return Object.defineProperty(u,i,{configurable:!0,enumerable:!0,get(){return s[i]},set(L){s[i]=L}}),T;return u[i]=T,T},set(j,i,M,T){return i in u?u[i]=M:s[i]=M,!0},defineProperty(j,i,M){return Reflect.defineProperty(u,i,M)},deleteProperty(j,i){return Reflect.deleteProperty(u,i)}},I=Object.create(s);return new Proxy(I,P)},l=s=>({addListener(n,f,...u){n.addListener(s.get(f),...u)},hasListener(n,f){return n.hasListener(s.get(f))},removeListener(n,f){n.removeListener(s.get(f))}}),S=new m(s=>typeof s!="function"?s:function(f){let u=x(f,{},{getContent:{minArgs:0,maxArgs:0}});s(u)}),h=new m(s=>typeof s!="function"?s:function(f,u,P){let I=!1,j,i=new Promise(q=>{j=function(R){I=!0,q(R)}}),M;try{M=s(f,u,j)}catch(q){M=Promise.reject(q)}let T=M!==!0&&d(M);if(M!==!0&&!T&&!I)return!1;let L=q=>{q.then(R=>{P(R)},R=>{let xe;R&&(R instanceof Error||typeof R.message=="string")?xe=R.message:xe="An unexpected error occurred",P({__mozWebExtensionPolyfillReject__:!0,message:xe})}).catch(R=>{})};return L(T?M:i),!0}),v=({reject:s,resolve:n},f)=>{o.runtime.lastError?o.runtime.lastError.message===t?n():s(new Error(o.runtime.lastError.message)):f&&f.__mozWebExtensionPolyfillReject__?s(new Error(f.message)):n(f)},E=(s,n,f,...u)=>{if(u.length<n.minArgs)throw new Error(`Expected at least ${n.minArgs} ${c(n.minArgs)} for ${s}(), got ${u.length}`);if(u.length>n.maxArgs)throw new Error(`Expected at most ${n.maxArgs} ${c(n.maxArgs)} for ${s}(), got ${u.length}`);return new Promise((P,I)=>{let j=v.bind(null,{resolve:P,reject:I});u.push(j),f.sendMessage(...u)})},O={devtools:{network:{onRequestFinished:l(S)}},runtime:{onMessage:l(h),onMessageExternal:l(h),sendMessage:E.bind(null,"sendMessage",{minArgs:1,maxArgs:3})},tabs:{sendMessage:E.bind(null,"sendMessage",{minArgs:2,maxArgs:3})}},$={clear:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}};return a.privacy={network:{"*":$},services:{"*":$},websites:{"*":$}},x(o,O,a)};e.exports=r(chrome)}else e.exports=globalThis.browser})});var dt=Y((js,ut)=>{"use strict";ut.exports=()=>{let e={};return e.promise=new Promise((t,r)=>{e.resolve=t,e.reject=r}),e}});var ct=Y((Ms,pt)=>{"use strict";var So=dt();function Co(e,t="maxAge"){let r,o,a,m=async()=>{if(r!==void 0)return;let c=async A=>{a=So();let b=A[1][t]-Date.now();if(b<=0){e.delete(A[0]),a.resolve();return}return r=A[0],o=setTimeout(()=>{e.delete(A[0]),a&&a.resolve()},b),typeof o.unref=="function"&&o.unref(),a.promise};try{for(let A of e)await c(A)}catch{}r=void 0},d=()=>{r=void 0,o!==void 0&&(clearTimeout(o),o=void 0),a!==void 0&&(a.reject(void 0),a=void 0)},y=e.set.bind(e);return e.set=(c,A)=>{e.has(c)&&e.delete(c);let b=y(c,A);return r&&r===c&&d(),m(),b},m(),e}pt.exports=Co});var xt=Y((Os,gt)=>{"use strict";var Eo=ct(),we=class{constructor(t,r){if(this.maxAge=t,this[Symbol.toStringTag]="Map",this.data=new Map,Eo(this.data),r)for(let[o,a]of r)this.set(o,a)}get size(){return this.data.size}clear(){this.data.clear()}delete(t){return this.data.delete(t)}has(t){return this.data.has(t)}get(t){let r=this.data.get(t);if(r)return r.data}set(t,r){return this.data.set(t,{maxAge:Date.now()+this.maxAge,data:r}),this}values(){return this.createIterator(t=>t[1].data)}keys(){return this.data.keys()}entries(){return this.createIterator(t=>[t[0],t[1].data])}forEach(t,r){for(let[o,a]of this.entries())t.apply(r,[a,o,this])}[Symbol.iterator](){return this.entries()}*createIterator(t){for(let r of this.data.entries())yield t(r)}};gt.exports=we});var g=K(V());var Nt=typeof global=="object"&&global&&global.Object===Object&&global,X=Nt;var Rt=typeof self=="object"&&self&&self.Object===Object&&self,_t=X||Rt||Function("return this")(),C=_t;var Bt=C.Symbol,D=Bt;var je=Object.prototype,Ut=je.hasOwnProperty,Gt=je.toString,z=D?D.toStringTag:void 0;function Lt(e){var t=Ut.call(e,z),r=e[z];try{e[z]=void 0;var o=!0}catch{}var a=Gt.call(e);return o&&(t?e[z]=r:delete e[z]),a}var Me=Lt;var Dt=Object.prototype,Ft=Dt.toString;function Wt(e){return Ft.call(e)}var Oe=Wt;var $t="[object Null]",qt="[object Undefined]",Ne=D?D.toStringTag:void 0;function Kt(e){return e==null?e===void 0?qt:$t:Ne&&Ne in Object(e)?Me(e):Oe(e)}var _=Kt;function Vt(e){return e!=null&&typeof e=="object"}var F=Vt;var zt=Array.isArray,Re=zt;function Ht(e){var t=typeof e;return e!=null&&(t=="object"||t=="function")}var Q=Ht;var Jt="[object AsyncFunction]",Zt="[object Function]",Yt="[object GeneratorFunction]",Xt="[object Proxy]";function Qt(e){if(!Q(e))return!1;var t=_(e);return t==Zt||t==Yt||t==Jt||t==Xt}var ee=Qt;var er=C["__core-js_shared__"],te=er;var _e=function(){var e=/[^.]+$/.exec(te&&te.keys&&te.keys.IE_PROTO||"");return e?"Symbol(src)_1."+e:""}();function tr(e){return!!_e&&_e in e}var Be=tr;var rr=Function.prototype,or=rr.toString;function ar(e){if(e!=null){try{return or.call(e)}catch{}try{return e+""}catch{}}return""}var B=ar;var sr=/[\\^$.*+?()[\]{}|]/g,nr=/^\[object .+?Constructor\]$/,ir=Function.prototype,fr=Object.prototype,mr=ir.toString,lr=fr.hasOwnProperty,ur=RegExp("^"+mr.call(lr).replace(sr,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function dr(e){if(!Q(e)||Be(e))return!1;var t=ee(e)?ur:nr;return t.test(B(e))}var Ue=dr;function pr(e,t){return e?.[t]}var Ge=pr;function cr(e,t){var r=Ge(e,t);return Ue(r)?r:void 0}var N=cr;var gr=N(C,"WeakMap"),re=gr;var xr=9007199254740991;function Ar(e){return typeof e=="number"&&e>-1&&e%1==0&&e<=xr}var oe=Ar;function hr(e){return e!=null&&oe(e.length)&&!ee(e)}var Le=hr;var yr=Object.prototype;function br(e){var t=e&&e.constructor,r=typeof t=="function"&&t.prototype||yr;return e===r}var ae=br;var Tr="[object Arguments]";function wr(e){return F(e)&&_(e)==Tr}var he=wr;var De=Object.prototype,vr=De.hasOwnProperty,Pr=De.propertyIsEnumerable,kr=he(function(){return arguments}())?he:function(e){return F(e)&&vr.call(e,"callee")&&!Pr.call(e,"callee")},Fe=kr;function Sr(){return!1}var We=Sr;var Ke=typeof exports=="object"&&exports&&!exports.nodeType&&exports,$e=Ke&&typeof module=="object"&&module&&!module.nodeType&&module,Cr=$e&&$e.exports===Ke,qe=Cr?C.Buffer:void 0,Er=qe?qe.isBuffer:void 0,Ir=Er||We,Ve=Ir;var jr="[object Arguments]",Mr="[object Array]",Or="[object Boolean]",Nr="[object Date]",Rr="[object Error]",_r="[object Function]",Br="[object Map]",Ur="[object Number]",Gr="[object Object]",Lr="[object RegExp]",Dr="[object Set]",Fr="[object String]",Wr="[object WeakMap]",$r="[object ArrayBuffer]",qr="[object DataView]",Kr="[object Float32Array]",Vr="[object Float64Array]",zr="[object Int8Array]",Hr="[object Int16Array]",Jr="[object Int32Array]",Zr="[object Uint8Array]",Yr="[object Uint8ClampedArray]",Xr="[object Uint16Array]",Qr="[object Uint32Array]",p={};p[Kr]=p[Vr]=p[zr]=p[Hr]=p[Jr]=p[Zr]=p[Yr]=p[Xr]=p[Qr]=!0;p[jr]=p[Mr]=p[$r]=p[Or]=p[qr]=p[Nr]=p[Rr]=p[_r]=p[Br]=p[Ur]=p[Gr]=p[Lr]=p[Dr]=p[Fr]=p[Wr]=!1;function eo(e){return F(e)&&oe(e.length)&&!!p[_(e)]}var ze=eo;function to(e){return function(t){return e(t)}}var He=to;var Je=typeof exports=="object"&&exports&&!exports.nodeType&&exports,H=Je&&typeof module=="object"&&module&&!module.nodeType&&module,ro=H&&H.exports===Je,ye=ro&&X.process,oo=function(){try{var e=H&&H.require&&H.require("util").types;return e||ye&&ye.binding&&ye.binding("util")}catch{}}(),be=oo;var Ze=be&&be.isTypedArray,ao=Ze?He(Ze):ze,Ye=ao;function so(e,t){return function(r){return e(t(r))}}var Xe=so;var no=Xe(Object.keys,Object),Qe=no;var io=Object.prototype,fo=io.hasOwnProperty;function mo(e){if(!ae(e))return Qe(e);var t=[];for(var r in Object(e))fo.call(e,r)&&r!="constructor"&&t.push(r);return t}var et=mo;var lo=N(C,"Map"),se=lo;var uo=N(C,"DataView"),ne=uo;var po=N(C,"Promise"),ie=po;var co=N(C,"Set"),fe=co;var tt="[object Map]",go="[object Object]",rt="[object Promise]",ot="[object Set]",at="[object WeakMap]",st="[object DataView]",xo=B(ne),Ao=B(se),ho=B(ie),yo=B(fe),bo=B(re),G=_;(ne&&G(new ne(new ArrayBuffer(1)))!=st||se&&G(new se)!=tt||ie&&G(ie.resolve())!=rt||fe&&G(new fe)!=ot||re&&G(new re)!=at)&&(G=function(e){var t=_(e),r=t==go?e.constructor:void 0,o=r?B(r):"";if(o)switch(o){case xo:return st;case Ao:return tt;case ho:return rt;case yo:return ot;case bo:return at}return t});var nt=G;var To="[object Map]",wo="[object Set]",vo=Object.prototype,Po=vo.hasOwnProperty;function ko(e){if(e==null)return!0;if(Le(e)&&(Re(e)||typeof e=="string"||typeof e.splice=="function"||Ve(e)||Ye(e)||Fe(e)))return!e.length;var t=nt(e);if(t==To||t==wo)return!e.size;if(ae(e))return!et(e).length;for(var r in e)if(Po.call(e,r))return!1;return!0}var Te=ko;var J=K(V());var U="https://chat.openai.com";async function it({key:e,value:t}){return J.default.storage.local.set({[e]:t})}async function me(){let{provider:e="chatgpt"}=await J.default.storage.local.get("provider"),t="provider:gpt3",r=await J.default.storage.local.get(t),o=await J.default.storage.local.get("chatModel");return{provider:e,configs:{["gpt3"]:r[t]},chatModel:o.chatModel}}var ft="gpt-3.5-turbo",mt="api.openai.com",lt="text-davinci-002-render-sha";var Tt=K(xt());var le,Io=new Uint8Array(16);function ve(){if(!le&&(le=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!le))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return le(Io)}var k=[];for(let e=0;e<256;++e)k.push((e+256).toString(16).slice(1));function At(e,t=0){return(k[e[t+0]]+k[e[t+1]]+k[e[t+2]]+k[e[t+3]]+"-"+k[e[t+4]]+k[e[t+5]]+"-"+k[e[t+6]]+k[e[t+7]]+"-"+k[e[t+8]]+k[e[t+9]]+"-"+k[e[t+10]]+k[e[t+11]]+k[e[t+12]]+k[e[t+13]]+k[e[t+14]]+k[e[t+15]]).toLowerCase()}var jo=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Pe={randomUUID:jo};function Mo(e,t,r){if(Pe.randomUUID&&!t&&!e)return Pe.randomUUID();e=e||{};let o=e.random||(e.rng||ve)();if(o[6]=o[6]&15|64,o[8]=o[8]&63|128,t){r=r||0;for(let a=0;a<16;++a)t[r+a]=o[a];return t}return At(o)}var W=Mo;function ht(e){let t,r,o,a,m,d,y;return c(),{feed:A,reset:c};function c(){t=!0,r="",o=0,a=-1,m=void 0,d=void 0,y=""}function A(w){r=r?r+w:w,t&&Oo(r)&&(r=r.slice(yt.length)),t=!1;let x=r.length,l=0,S=!1;for(;l<x;){S&&(r[l]===`
`&&++l,S=!1);let h=-1,v=a,E;for(let O=o;h<0&&O<x;++O)E=r[O],E===":"&&v<0?v=O-l:E==="\r"?(S=!0,h=O-l):E===`
`&&(h=O-l);if(h<0){o=x-l,a=v;break}else o=0,a=-1;b(r,l,v,h),l+=h+1}l===x?r="":l>0&&(r=r.slice(l))}function b(w,x,l,S){if(S===0){y.length>0&&(e({type:"event",id:m,event:d||void 0,data:y.slice(0,-1)}),y="",m=void 0),d=void 0;return}let h=l<0,v=w.slice(x,x+(h?S:l)),E=0;h?E=S:w[x+l+1]===" "?E=l+2:E=l+1;let O=x+E,$=S-E,s=w.slice(O,O+$).toString();if(v==="data")y+=s?"".concat(s,`
`):`
`;else if(v==="event")d=s;else if(v==="id"&&!s.includes("\0"))m=s;else if(v==="retry"){let n=parseInt(s,10);Number.isNaN(n)||e({type:"reconnect-interval",value:n})}}}var yt=[239,187,191];function Oo(e){return yt.every((t,r)=>e.charCodeAt(r)===t)}async function*bt(e){let t=e.getReader();try{for(;;){let{done:r,value:o}=await t.read();if(r)return;yield o}}finally{t.releaseLock()}}async function ue(e,t){let{onMessage:r,...o}=t,a=await fetch(e,o);if(!a.ok){let d=await a.json().catch(()=>({}));throw new Error(Te(d)?`${a.status} ${a.statusText}`:JSON.stringify(d))}let m=ht(d=>{d.type==="event"&&r(d.data)});for await(let d of bt(a.body)){let y=new TextDecoder().decode(d);m.feed(y)}}var wt=K(V());async function de(e,t,r,o){return fetch(`${U}/backend-api${r}`,{method:t,headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:o===void 0?void 0:JSON.stringify(o)})}async function vt(e,t){await de(e,"POST","/conversation/message_feedback",t)}async function No(e,t,r){await de(e,"PATCH",`/conversation/${t}`,r)}var ke="accessToken",Se=new Tt.default(10*1e3);async function ce(){if(Se.get(ke))return Se.get(ke);let e=await fetch(`${U}/api/auth/session`);if(e.status===403)throw new Error("CLOUDFLARE");let t=await e.json().catch(()=>({}));if(!t.accessToken)throw new Error("UNAUTHORIZED");return Se.set(ke,t.accessToken),t.accessToken}var pe=class{constructor(t){this.token=t;this.tasks={};this.token=t}async fetchModels(){return(await de(this.token,"GET","/models").then(r=>r.json())).models}async getModelName(){var t,r;try{let o=(r=(t=await wt.default.storage.local.get("chatModel"))==null?void 0:t.chatModel)!=null?r:"GPT-3.5 Turbo",a=await this.fetchModels();if(o==="auto"){let m=a.find(d=>d.slug==="gpt-4");return(m==null?void 0:m.slug)||a[0].slug}return a[0].slug}catch(o){return lt}}async generateAnswer(t){let r,{taskId:o,prompt:a}=t,m=W(),d=()=>{r&&No(this.token,r,{is_visible:!1})},y=await this.getModelName(),c=new AbortController;return this.tasks[o]={abortController:c},await ue(`${U}/backend-api/conversation`,{method:"POST",signal:c.signal,headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.token}`},body:JSON.stringify({action:"next",messages:[{id:m,role:"user",content:{content_type:"text",parts:[a]}}],model:y,parent_message_id:W()}),onMessage(A){var x,l,S;if(A==="[DONE]"){t.onEvent({type:"done"}),d();return}let b;try{b=JSON.parse(A)}catch(h){return}let w=(S=(l=(x=b.message)==null?void 0:x.content)==null?void 0:l.parts)==null?void 0:S[0];w&&(r=b.conversation_id,t.onEvent({type:"answer",data:{text:w,messageId:b.message.id,conversationId:b.conversation_id}}))}}),{cleanup:d}}cancelTask(t){let r=this.tasks[t];r&&r.abortController.abort()}async updateTitle(t){let{conversationId:r,messageId:o}=t,a=await this.getModelName();return await de(this.token,"POST",`/conversation/gen_title/${r}`,{message_id:o,model:a})}};var ge=class{constructor(t,r){this.token=t;this.model=r;this.tasks={};this.token=t,this.model=r}buildPrompt(t){return this.model.startsWith("text-chat-davinci")?`Respond conversationally.<|im_end|>

User: ${t}<|im_sep|>
ChatGPT:`:t}buildMessages(t){return[{role:"user",content:t}]}async generateAnswer(t){var w,x,l;let[r]=await Promise.all([me()]),o=(x=(w=r.configs["gpt3"])==null?void 0:w.model)!=null?x:ft,a=((l=r.configs["gpt3"])==null?void 0:l.apiHost)||mt,{taskId:m,prompt:d}=t,y="",c={model:this.model,stream:!0,max_tokens:800};o==="text-davinci-003"?(y=`https://${a}/v1/completions`,c={...c,prompt:this.buildPrompt(d)}):(y=`https://${a}/v1/chat/completions`,c={...c,messages:this.buildMessages(d)});let A="",b=new AbortController;return this.tasks[m]={abortController:b},await ue(y,{method:"POST",signal:b.signal,headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.token}`},body:JSON.stringify(c),onMessage(S){if(S==="[DONE]"){t.onEvent({type:"done"});return}let h;try{h=JSON.parse(S);let v=o==="text-davinci-003"?h.choices[0].text:h.choices[0].delta.content;if(v===void 0||v==="<|im_end|>"||v==="<|im_sep|>")return;A+=v,t.onEvent({type:"answer",data:{text:A,messageId:h.id,conversationId:h.id}})}catch(v){return}}}),{}}cancelTask(t){let r=this.tasks[t];r&&r.abortController.abort()}};var Ce=K(V());var an=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),Pt=navigator.userAgent.indexOf("Firefox")!=-1,sn=/iPad|iPhone|iPod/.test(navigator.userAgent);function kt(e){let{id:t,url:r}=e;r.includes(`${U}/chat`)?Ce.default.tabs.sendMessage(t,{type:"CHATGPT_TAB_CURRENT",data:{isLogin:!0}}).catch(()=>{}):Ce.default.tabs.sendMessage(t,{type:"CHATGPT_TAB_CURRENT",data:{isLogin:!1}}).catch(()=>{})}var Z;async function _o(e,t){let r=await me();if(r.provider==="chatgpt"){let m=await ce();Z=new pe(m)}else if(r.provider==="gpt3"){let{apiKey:m,model:d}=r.configs["gpt3"];Z=new ge(m,d)}else throw new Error(`Unknown provider ${r.provider}`);let o=W();e.onDisconnect.addListener(()=>{Z.cancelTask(o),a==null||a()}),await it({key:"taskId",value:o});let{cleanup:a}=await Z.generateAnswer({prompt:t,taskId:o,onEvent(m){if(m.type==="done"){e.postMessage({event:"DONE"});return}e.postMessage(m.data)}})}async function Bo(e){Z.cancelTask(e)}async function Uo(e){g.default.tabs.query({currentWindow:!0,active:!0}).then(o=>{let a=o[0];a.id&&g.default.storage.local.set({glarityTabId:a.id})});let t=await g.default.storage.local.get("pinnedTabId"),r;if(t.pinnedTabId)try{r=await g.default.tabs.get(t.pinnedTabId),g.default.tabs.update(r.id,{active:!0,pinned:!0})}catch(o){}return r||(r=await g.default.tabs.create({url:e,pinned:!0,active:!0})),g.default.storage.local.set({pinnedTabId:r.id}),{pinnedTabId:r.id}}g.default.runtime.onConnect.addListener(async e=>{e.onMessage.addListener(async t=>{try{await _o(e,t.question)}catch(r){e.postMessage({error:r.message})}})});g.default.runtime.onMessage.addListener(async e=>{if(e.type==="FEEDBACK"){let t=await ce();await vt(t,e.data)}else if(e.type==="OPEN_OPTIONS_PAGE")g.default.runtime.openOptionsPage();else{if(e.type==="GET_ACCESS_TOKEN")return ce();if(e.type==="NEW_TAB")return Uo(e.data.url);if(e.type==="GO_BACK"){let t=await g.default.storage.local.get("glarityTabId");t.glarityTabId?g.default.tabs.update(t.glarityTabId,{active:!0}).catch(()=>{g.default.tabs.create({url:"about:newtab",active:!0})}):g.default.tabs.create({url:"about:newtab",active:!0})}else e.type==="STOP_TASK"&&await Bo(e.data.taskId)}});g.default.runtime.onInstalled.addListener(async e=>{e.reason==="install"&&g.default.runtime.openOptionsPage()});g.default.tabs.onUpdated.addListener(async(e,t)=>{let r=await g.default.storage.local.get("pinnedTabId");g.default.tabs.get(e).then(o=>{var a;(a=o.url)!=null&&a.includes(U)&&t.status==="complete"&&o.id&&r.pinnedTabId===o.id&&kt(o)})});async function St(e){let{id:t}=e;t&&g.default.tabs.sendMessage(t,{type:"OPEN_WEB_SUMMARY",data:{}}).catch(()=>{})}Pt?g.default.browserAction.onClicked.addListener(async e=>{await St(e)}):g.default.action.onClicked.addListener(async e=>{await St(e)});})();
